name: Deploy FastAPI to Server

on:
  push:
    branches: [ main ]
    paths:
      - 'project2/nextjs_fastapi/**'
      - '.github/workflows/deploy-fastapi.yml'
      - 'project2/nextjs_testing/src/a'
  workflow_dispatch:  # 允许手动触发

# 安全说明：
# - 所有敏感信息存储在GitHub Secrets中（Settings > Secrets > Actions）
# - Secrets是加密的，不会出现在日志中
# - 建议：使用SSH密钥而非密码，并限制SSH用户权限
# - 建议：在服务器上创建专门的部署用户，只给必要权限

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}  # 使用SSH密钥，不用密码
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          # 进入项目目录（使用正确的路径）
          cd ~/apps/tailwind_test || mkdir -p ~/apps/tailwind_test && cd ~/apps
          
          # 如果有旧的repo，拉取更新；否则克隆
          if [ -d "tailwind_test/.git" ]; then
            cd tailwind_test
            git fetch origin
            git reset --hard origin/main
            git clean -fd
          else
            git clone https://github.com/${{ github.repository }}.git tailwind_test
            cd tailwind_test
          fi
          
          # 进入FastAPI目录
          cd project2/nextjs_fastapi
          
          # 创建虚拟环境（如果不存在）
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          
          # 激活虚拟环境并安装依赖
          source venv/bin/activate
          pip install --upgrade pip
          pip install pyaudioop  # Python 3.13兼容性
          pip install -r requirements.txt
          
          # 创建.env文件
          cat > .env << 'EOF'
          GITHUB_TOKEN=${{ secrets.HUGHES_GITHUB_TOKEN }}
          HUGHES_GITHUB_TOKEN=${{ secrets.HUGHES_GITHUB_TOKEN }}
          EOF
          
          # 创建或更新systemd服务
          sudo tee /etc/systemd/system/hughes-api.service > /dev/null << 'SERVICE'
          [Unit]
          Description=Hughes API FastAPI Service
          After=network.target
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/root/apps/tailwind_test/project2/nextjs_fastapi
          Environment="PATH=/root/apps/tailwind_test/project2/nextjs_fastapi/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
          Environment="GITHUB_TOKEN=${{ secrets.HUGHES_GITHUB_TOKEN }}"
          Environment="HUGHES_GITHUB_TOKEN=${{ secrets.HUGHES_GITHUB_TOKEN }}"
          ExecStart=/root/apps/tailwind_test/project2/nextjs_fastapi/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
          SERVICE
          
          # 重载并重启服务
          sudo systemctl daemon-reload
          sudo systemctl enable hughes-api
          sudo systemctl restart hughes-api
          
          echo "Deployment completed!"
    
    - name: Check service status
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          # 检查服务状态
          sudo systemctl status hughes-api --no-pager || echo "Service not yet configured"
          
          # 等待服务启动
          sleep 3
          
          # 测试API端点
          echo "Testing API endpoints..."
          curl -s http://localhost:8000/ || echo "API root not responding"
          curl -s http://localhost:8000/api/hughes/status || echo "Hughes API not responding"
          
          # 触发数据同步
          echo "Triggering Hughes data sync..."
          curl -X GET http://localhost:8000/api/hughes/sync || echo "Sync failed"
          
          # 验证数据是否同步成功
          echo "Verifying data sync..."
          sleep 2
          curl -s http://localhost:8000/api/hughes/messages | head -c 200
          
          # 显示最近日志
          echo "Recent logs:"
          sudo journalctl -u hughes-api -n 20 --no-pager